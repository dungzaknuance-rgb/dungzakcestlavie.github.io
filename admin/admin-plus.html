<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Admin＋ · DUNGZAK CESTLAVIE</title>
<style>
:root{--bg:#0a0f22;--fg:#e9f1ff;--mut:#9fb0d8;--line:#213064;--gold:#e6c777;--ok:#3ac17e;--bad:#ff6b6b;--panel:#0f1838;--pill:#16224a}
*{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 700px at 70% -10%, #182448 0, #0a0f22 40%, #080d1c 100%);color:var(--fg);font:15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif}
header{position:sticky;top:0;z-index:10;background:#0a1028cc;backdrop-filter:blur(8px);border-bottom:1px solid #1c2853;padding:10px 12px}
h1{margin:6px 0 0;font-size:18px;color:var(--gold)} small{color:var(--mut)}
main{max-width:1100px;margin:20px auto;padding:0 12px}
section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin:12px 0}
h2{margin:0 0 10px;font-size:16px;color:#f6e9b4}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input[type=text], input[type=password], textarea, select{background:#0e1636;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
input[type=text], input[type=password]{min-width:220px}
textarea{width:100%;min-height:120px}
button{background:var(--pill);color:#dfe8ff;border:1px solid #2c3b7c;border-radius:10px;padding:8px 12px;cursor:pointer}
button:hover{background:#1a2a5a}
.btn-ok{border-color:#3f8d6a;color:#eafff4;background:#143a2c}
.btn-bad{border-color:#8d3f3f;color:#ffecec;background:#3a1414}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
hr{border:none;border-top:1px dashed #2a3a78;margin:12px 0}
.note{color:#bcd0ff}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:960px){.grid{grid-template-columns:repeat(4,1fr)}}
.card{background:#0f1434;border:1px solid #1f2b62;border-radius:10px;padding:8px;display:flex;gap:8px;align-items:center}
.card img{width:76px;height:76px;object-fit:cover;border-radius:8px;border:1px solid #24336b;background:#0a0f22}
.card .meta{flex:1}
.pill{display:inline-block;padding:2px 8px;border:1px solid #2b3a76;border-radius:999px;background:#121c46;color:#cfe0ff;font-size:12px}
.drag{cursor:grab}
.drop{border:2px dashed #3a447a; border-radius:10px; padding:20px; text-align:center; color:#cfe0ff; background:#0e1636}
.badge{font-size:12px;border-radius:8px;padding:2px 6px;border:1px solid #2a3a78;background:#122054}
.success{color:#b4ffd5} .error{color:#ffbcbc}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.tab{padding:8px 12px;border:1px solid #2a3a78;border-radius:999px;background:#121c46;color:#cfe0ff;cursor:pointer}
.tab.active{background:linear-gradient(180deg,#f6e29c,#e6c777);color:#0a1230;border-color:#d9c16a}
ul.clean{list-style:none;margin:0;padding:0;display:grid;gap:8px}
.actions{display:flex;gap:6px;flex-wrap:wrap}
footer{padding:20px 12px;color:#9fb0d8;text-align:center}
</style>
</head>
<body>
<header>
  <h1>Admin＋ <small>· DUNGZAK CESTLAVIE</small></h1>
  <small class="note">브라우저에서 GitHub API로 직접 커밋합니다. 토큰은 로컬에만 저장됩니다.</small>
</header>

<main>

<!-- 1) 연결 설정 -->
<section id="auth">
  <h2>① 연결 설정</h2>
  <div class="row kv">
    <label>Owner / Repo</label>
    <div class="row">
      <input id="owner" type="text" placeholder="owner" />
      <span style="align-self:center">/</span>
      <input id="repo" type="text" placeholder="repo" />
      <input id="branch" type="text" value="main" style="width:110px" />
    </div>
    <label>GitHub Token</label>
    <input id="token" type="password" placeholder="ghp_..." />
    <label></label>
    <div class="row">
      <button class="btn-ok" id="saveAuth">저장</button>
      <button id="clearAuth">삭제</button>
      <span id="authState" class="badge">대기</span>
    </div>
  </div>
  <hr>
  <div class="note">권한: 공개 저장소면 <b>public_repo</b> 범위면 충분. 토큰은 <code>localStorage</code>에만 저장됩니다.</div>
</section>

<!-- 2) 작품 관리 -->
<section id="works">
  <h2>② 작품 관리 (업로드/삭제/교체/순서변경)</h2>
  <div class="tabs" id="workTabs"></div>
  <div class="row">
    <div id="drop" class="drop" style="flex:1">여기로 이미지를 드래그하거나 클릭하여 선택 (여러 장 가능)</div>
    <div class="row" style="align-items:flex-start">
      <div>
        <div class="pill">파일명 규칙: <b>works/{섹션}/{번호}.jpg</b></div>
        <div class="note" style="margin-top:6px">새로 올리면 빈 번호부터 자동 채웁니다. 드래그로 순서 바꾼 뒤 <b>순서 저장</b>을 누르면 자동으로 재번호/커밋.</div>
      </div>
    </div>
  </div>
  <hr>
  <ul id="workList" class="clean"></ul>
  <div class="row" style="justify-content:flex-end;margin-top:8px">
    <button id="saveOrder" class="btn-ok">순서 저장(재번호 커밋)</button>
  </div>
</section>

<!-- 3) 미학 보고서 관리 -->
<section id="reports">
  <h2>③ 미학 보고서 관리 (DCAR)</h2>
  <div class="row">
    <button id="loadReports">불러오기</button>
    <button id="addReport">새 보고서 추가</button>
    <button id="saveReports" class="btn-ok">보고서 저장</button>
    <span class="pill">파일: <code>data/reports.json</code></span>
  </div>
  <div id="reportsWrap"></div>
  <hr>
  <div class="row">
    <label class="pill">선택사항</label>
    <button id="genPages">각 보고서의 HTML 템플릿 생성(/reports/ID.html)</button>
  </div>
</section>

</main>

<footer>© 2025 DUNGZAK CESTLAVIE · Admin＋</footer>

<script>
/* ===== Utilities ===== */
const $ = sel => document.querySelector(sel);
const el = (tag, attrs={}, ...kids) => {
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v]) => {
    if(k==='class') n.className=v;
    else if(k==='html') n.innerHTML=v;
    else n.setAttribute(k,v);
  });
  kids.forEach(k => n.appendChild(typeof k==='string' ? document.createTextNode(k) : k));
  return n;
};
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ===== Auth storage ===== */
const auth = {
  get: () => ({
    owner: localStorage.getItem('dz_owner') || '',
    repo: localStorage.getItem('dz_repo') || '',
    branch: localStorage.getItem('dz_branch') || 'main',
    token: localStorage.getItem('dz_token') || ''
  }),
  set: (o) => {
    localStorage.setItem('dz_owner', o.owner);
    localStorage.setItem('dz_repo', o.repo);
    localStorage.setItem('dz_branch', o.branch);
    localStorage.setItem('dz_token', o.token);
  },
  clear: () => {
    ['dz_owner','dz_repo','dz_branch','dz_token'].forEach(k=>localStorage.removeItem(k));
  }
};
(function initAuth(){
  const a=auth.get();
  $('#owner').value=a.owner; $('#repo').value=a.repo; $('#branch').value=a.branch; $('#token').value=a.token;
  $('#saveAuth').onclick=()=>{
    auth.set({owner:$('#owner').value.trim(), repo:$('#repo').value.trim(), branch:$('#branch').value.trim(), token:$('#token').value.trim()});
    $('#authState').textContent='저장됨';
  };
  $('#clearAuth').onclick=()=>{auth.clear(); $('#authState').textContent='삭제됨';};
})();

/* ===== GitHub API wrap (Contents API) ===== */
function ghHeaders(){ const {token}=auth.get(); return {'Authorization':'token '+token,'Accept':'application/vnd.github+json'}; }
function ghBase(){ const {owner,repo}=auth.get(); return `https://api.github.com/repos/${owner}/${repo}`; }
async function ghGet(path){
  const r=await fetch(`${ghBase()}/contents/${path}?ref=${encodeURIComponent(auth.get().branch)}`,{headers:ghHeaders()});
  if(!r.ok) throw new Error('GET '+path+' '+r.status); return r.json();
}
async function ghPut(path, contentBase64, message, sha=null){
  const body={message, content:contentBase64, branch:auth.get().branch}; if(sha) body.sha=sha;
  const r=await fetch(`${ghBase()}/contents/${path}`,{method:'PUT',headers:ghHeaders(),body:JSON.stringify(body)});
  if(!r.ok){const t=await r.text(); throw new Error('PUT '+path+' '+r.status+' '+t);} return r.json();
}
async function ghDel(path, sha, message){
  const r=await fetch(`${ghBase()}/contents/${path}`,{method:'DELETE',headers:ghHeaders(),body:JSON.stringify({message, sha, branch:auth.get().branch})});
  if(!r.ok){const t=await r.text(); throw new Error('DEL '+path+' '+r.status+' '+t);} return r.json();
}
async function fileSha(path){ try{const x=await ghGet(path); return x.sha;}catch(e){return null;} }
async function ensureDirExists(){ /* Contents API auto-creates path on PUT; nothing needed */ }

/* ===== Works manager ===== */
const sections = [
  {key:'light', title:'Ⅰ Light & Memory'},
  {key:'prayer', title:'Ⅱ Human Prayer'},
  {key:'rebirth', title:'Ⅲ Rebirth'},
  {key:'exist', title:'Ⅳ Existence'},
  {key:'cosmos', title:'Ⅴ Cosmos'},
];
let activeKey = 'light', workCache = {}; // {key: [{name,sha,download_url}]}

function makeTabs(){
  const wrap = $('#workTabs');
  sections.forEach(s=>{
    const b = el('button',{class:'tab'+(s.key===activeKey?' active':''), 'data-key':s.key}, s.title);
    b.onclick=()=>{wrap.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); activeKey=s.key; loadWorkList();};
    wrap.appendChild(b);
  });
}
makeTabs();

async function listImages(key){
  const path=`works/${key}`;
  try{
    const arr = await ghGet(path);
    return arr.filter(i=>/\.(jpg|jpeg|png|webp)$/i.test(i.name))
              .sort((a,b)=>parseInt(a.name)-parseInt(b.name));
  }catch(e){ return []; }
}

async function loadWorkList(){
  $('#workList').innerHTML='불러오는 중…';
  workCache[activeKey] = await listImages(activeKey);
  const ul = el('ul',{class:'clean'});
  workCache[activeKey].forEach(it=>{
    ul.appendChild(workItem(it));
  });
  $('#workList').replaceChildren(...ul.children);
  enableDragSort();
}
function workItem(it){
  const idx = parseInt(it.name);
  const li = el('li',{},
    el('div',{class:'card drag', draggable:'true'},
      el('img',{src:it.download_url + '?t=' + Date.now()}),
      el('div',{class:'meta'},
        el('div',{}, `${activeKey} · ${idx}`),
        el('div',{}, el('span',{class:'pill'}, it.name))
      ),
      el('div',{class:'actions'},
        el('label',{},
          el('input',{type:'file', accept:'image/*', style:'display:none', id:'r'+it.name}),
          el('button',{},'교체')
        ),
        el('button',{class:'btn-bad', onclick:async ()=>{
          if(!confirm(`${it.name} 삭제할까요?`)) return;
          await ghDel(`works/${activeKey}/${it.name}`, it.sha, `delete: ${activeKey}/${it.name}`);
          await loadWorkList();
        }},'삭제')
      )
    )
  );
  li.querySelector('label').onclick=()=>li.querySelector('input').click();
  li.querySelector('input').onchange=async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const b64=await fileToBase64(f);
    await ghPut(`works/${activeKey}/${it.name}`, b64, `replace: ${activeKey}/${it.name}`, it.sha);
    await loadWorkList();
  };
  return li;
}
function enableDragSort(){
  const list = $('#workList');
  let dragging=null;
  list.querySelectorAll('.drag').forEach(card=>{
    card.addEventListener('dragstart',()=>{dragging=card; card.style.opacity=.5;});
    card.addEventListener('dragend',()=>{dragging=null; card.style.opacity=1;});
  });
  list.addEventListener('dragover',e=>{
    e.preventDefault();
    const after = [...list.children].find(li=>{
      const box=li.getBoundingClientRect(); return e.clientY < box.top + box.height/2;
    });
    if(dragging) list.insertBefore(dragging.parentElement, after||null);
  });
}
$('#saveOrder').onclick=async ()=>{
  // Rename visually-ordered items to 1.jpg..N.jpg (move = PUT new + DELETE old)
  const li = [...$('#workList').children];
  let n=1;
  for(const item of li){
    const name=item.querySelector('.pill').textContent;
    const sha=workCache[activeKey].find(x=>x.name===name).sha;
    const src=await fetch(workCache[activeKey].find(x=>x.name===name).download_url);
    const buf=new Uint8Array(await src.arrayBuffer());
    const b64=btoa([...buf].map(b=>String.fromCharCode(b)).join(''));
    const newName = `${n}.jpg`;
    if(name!==newName){
      await ghPut(`works/${activeKey}/${newName}`, b64, `move: ${activeKey}/${name} -> ${newName}`, await fileSha(`works/${activeKey}/${newName}`));
      await ghDel(`works/${activeKey}/${name}`, sha, `delete old after move: ${activeKey}/${name}`);
    }
    n++;
  }
  await loadWorkList();
  alert('순서 저장 완료!');
};

/* upload / drop */
const drop = $('#drop');
drop.addEventListener('click',()=> {
  const inp = el('input',{type:'file',accept:'image/*',multiple:true,style:'display:none'});
  document.body.appendChild(inp); inp.click();
  inp.onchange=(e)=>handleFiles(e.target.files); inp.remove();
});
drop.addEventListener('dragover',e=>{e.preventDefault(); drop.style.opacity=.9;});
drop.addEventListener('dragleave',()=>{drop.style.opacity=1;});
drop.addEventListener('drop',e=>{
  e.preventDefault(); drop.style.opacity=1; handleFiles(e.dataTransfer.files);
});
async function handleFiles(files){
  if(!files || !files.length) return;
  const list = await listImages(activeKey);
  let next = list.length+1;
  for(const f of files){
    const b64 = await fileToBase64(f);
    await ghPut(`works/${activeKey}/${next}.jpg`, b64, `upload: ${activeKey}/${next}.jpg`);
    next++;
  }
  await loadWorkList();
}
function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(file);}); }

/* ===== Reports manager ===== */
const reportsPath = 'data/reports.json';
let reportsData = [];

$('#loadReports').onclick = async ()=>{
  try{
    const j = await ghGet(reportsPath);
    const txt = atob(j.content);
    reportsData = JSON.parse(txt);
  }catch(e){
    reportsData = [
      {id:'DCAR-01-2025',title:'On Light, Memory, and Being',ko:'',en:''},
      {id:'DCAR-02-2025',title:'The Restoration of Being',ko:'',en:''}
    ];
  }
  renderReports();
};
$('#addReport').onclick = ()=>{ reportsData.push({id:'DCAR-XX-YYYY', title:'New Report', ko:'', en:''}); renderReports(); };
$('#saveReports').onclick = async ()=>{
  const txt = JSON.stringify(reportsData, null, 2);
  const sha = await fileSha(reportsPath);
  const b64 = btoa(unescape(encodeURIComponent(txt)));
  await ghPut(reportsPath, b64, 'update: data/reports.json', sha);
  alert('reports.json 저장 완료!');
};
$('#genPages').onclick = async ()=>{
  for(const r of reportsData){
    const html = reportTemplate(r);
    const path = `reports/${r.id}.html`;
    const sha = await fileSha(path);
    await ghPut(path, btoa(unescape(encodeURIComponent(html))), `generate: ${path}`, sha);
    await sleep(200);
  }
  alert('보고서 템플릿 생성 완료!');
};
function renderReports(){
  const wrap = $('#reportsWrap'); wrap.innerHTML='';
  reportsData.forEach((r,i)=>{
    wrap.appendChild(el('section',{},
      el('div',{class:'kv'},
        el('label',{},'ID'), el('input',{type:'text',value:r.id,oninput:e=>r.id=e.target.value}),
        el('label',{},'Title'), el('input',{type:'text',value:r.title,oninput:e=>r.title=e.target.value}),
        el('label',{},'Korean'), el('textarea',{oninput:e=>r.ko=e.target.value, html: r.ko||''}),
        el('label',{},'English'), el('textarea',{oninput:e=>r.en=e.target.value, html: r.en||''}),
        el('label',{}), el('div',{class:'actions'},
          el('button',{class:'btn-bad',onclick:()=>{ if(confirm('삭제?')){reportsData.splice(i,1); renderReports();} }},'삭제')
        )
      )
    ));
  });
}
function reportTemplate(r){
  return `<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${r.id} · ${r.title}</title>
<style>body{font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b1020;color:#e9efff;padding:24px}
a{color:#e6c777;text-decoration:none} h1{color:#e6c777}</style></head>
<body>
<h1>${r.id} · ${r.title}</h1>
<h3>KR</h3><p>${(r.ko||'').replace(/\n/g,'<br>')}</p>
<hr><h3>EN</h3><p>${(r.en||'').replace(/\n/g,'<br>')}</p>
<p><a href="/">← Back to Home</a></p>
</body></html>`;
}

/* ===== Boot ===== */
(async function boot(){
  // Set defaults from localStorage, guess owner/repo from URL if blank
  const a=auth.get();
  if(!a.owner || !a.repo){
    try{
      const m=location.pathname.match(/\/([^\/]+)\/([^\/]+)\//);
      if(m){ $('#owner').value=m[1]; $('#repo').value=m[2]; }
    }catch(e){}
  }
  await loadWorkList();
})();
</script>
</body>
</html>
