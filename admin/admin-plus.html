<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DUNGZAK Â· Admin â€” Artworks Manager Plus (Upload Â· Edit Â· Delete Â· Instant Refresh)</title>

<!-- ê°•ë ¥ ìºì‹œ ë¬´íš¨í™” -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
  :root{--bg:#0b0f1a;--card:#0f1524;--line:#20304a;--ink:#e8eefc;--sub:#9fb4d9;--ok:#8aff9c;--warn:#ffd36e;--err:#ff9aa2;--accent:#b6ff6e;}
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--ink);font-family:system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45;margin:0}
  .wrap{max-width:1000px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 10px}
  .pill{display:inline-block;margin-left:8px;padding:4px 10px;border-radius:999px;background:#13213a;color:#b9cef2;font-size:12px}
  fieldset{border:1px solid var(--line);border-radius:14px;background:var(--card);padding:16px;margin:14px 0}
  legend{padding:0 6px;color:#b9cef2}
  label{display:block;font-weight:700;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0e1422;color:var(--ink)}
  input[type=file]{padding:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;background:var(--accent);color:#0b0f1a}
  button.secondary{background:#1f2b44;color:var(--ink);border:1px solid var(--line)}
  button.warn{background:#f05454;color:#fff}
  .note{font-size:12px;color:var(--sub);margin-top:6px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .log{white-space:pre-wrap;background:#0a1220;border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px;font-size:12px;color:#b9cef2;max-height:240px;overflow:auto}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border-bottom:1px solid #1b2945;padding:9px}
  tr:hover{background:#0e1a31}
  .thumb{width:52px;height:52px;object-fit:cover;border-radius:8px;border:1px solid #1b2945}
  @media (max-width:680px){.row,.row3{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>ë“±ì‘ ç‡ˆé…Œ DUNGZAK CESTLAVIE â€” Artworks Manager Plus <span class="pill">Lightflow Î©.3</span></h1>

  <!-- 1) GitHub ì—°ê²° -->
  <fieldset>
    <legend>1) GitHub ì—°ê²°</legend>
    <div class="row">
      <div>
        <label>GitHub Owner</label>
        <input id="ghOwner" placeholder="ì˜ˆ: dungzakcestlavie">
      </div>
      <div>
        <label>Repository</label>
        <input id="ghRepo" placeholder="ì˜ˆ: dungzakcestlavie.github.io">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Branch</label>
        <input id="ghBranch" value="main">
      </div>
      <div>
        <label>Personal Access Token</label>
        <input id="ghToken" type="password" placeholder="repo ê¶Œí•œ í† í°">
      </div>
    </div>
    <div class="btns">
      <button id="saveCfg">ì €ì¥(ë¡œì»¬)</button>
      <button class="secondary" id="testConn">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
      <span id="connMsg" class="note"></span>
    </div>
  </fieldset>

  <!-- 2) ì‘í’ˆ ì—…ë¡œë“œ / ìˆ˜ì • / ì‚­ì œ -->
  <fieldset>
    <legend>2) ì‘í’ˆ ì—…ë¡œë“œ Â· ìˆ˜ì • Â· ì‚­ì œ</legend>
    <div class="row">
      <div>
        <label>Series</label>
        <select id="series">
          <option>I Light & Memory</option>
          <option>II Human Prayer</option>
          <option>III Rebirth</option>
          <option>IV Existence</option>
          <option>V Cosmos</option>
        </select>
      </div>
      <div>
        <label>Artwork ID <span class="note">ì˜ë¬¸/ìˆ«ì/í•˜ì´í”ˆ ê¶Œì¥ (ì˜ˆ: Dungzak-1)</span></label>
        <input id="artworkId" placeholder="Dungzak-1">
      </div>
    </div>
    <div class="row">
      <div><label>Title</label><input id="title" placeholder="ì‘í’ˆ ì œëª©"></div>
      <div><label>Year</label><input id="year" placeholder="2025"></div>
    </div>
    <div class="row">
      <div><label>Medium</label><input id="medium" placeholder="Acrylic on Canvas"></div>
      <div><label>Size</label><input id="size" placeholder="120x90 cm"></div>
    </div>
    <div>
      <label>Image (.jpg/.png)</label>
      <input id="imageFile" type="file" accept=".jpg,.jpeg,.png">
      <div class="note">ì´ë¯¸ì§€ëŠ” <b>assets/artworks/{ArtworkID}.{í™•ì¥ì}</b>ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
    </div>
    <div class="btns">
      <button id="btnSave">ì´ë¯¸ì§€ ì—…ë¡œë“œ + artworks.json ì €ì¥</button>
      <button class="secondary" id="btnSaveMeta">ì´ë¯¸ì§€ ì—†ì´ ë©”íƒ€ë°ì´í„°ë§Œ ì €ì¥</button>
      <button class="secondary" id="btnReplaceImg">ì´ë¯¸ì§€(íŒŒì¼ë§Œ) êµì²´</button>
      <button class="warn" id="btnDelete">ì´ ì‘í’ˆ ì‚­ì œ</button>
      <button id="btnNext">ì €ì¥ í›„ ë‹¤ìŒ ì‘í’ˆ(ID ìë™ ì¦ê°€)</button>
    </div>
    <div id="msg" class="note"></div>
  </fieldset>

  <!-- 3) ì‘í’ˆ ëª©ë¡ / ê²€ìƒ‰ / í´ë¦­-í¸ì§‘ -->
  <fieldset>
    <legend>3) ëª©ë¡ Â· ê²€ìƒ‰ Â· í´ë¦­ í¸ì§‘</legend>
    <div class="btns">
      <button id="btnReload" class="secondary">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
      <input id="searchBox" placeholder="ID/ì œëª©/ì‹œë¦¬ì¦ˆ ê²€ìƒ‰â€¦" style="max-width:320px">
    </div>
    <div id="listWrap"></div>
  </fieldset>

  <!-- 4) ì¼ë°˜ íŒŒì¼ ì—…ë¡œë“œ/ì‚­ì œ (ë³´ê³ ì„œ, ê¸°íƒ€ ë¦¬ì†ŒìŠ¤) -->
  <fieldset>
    <legend>4) ê¸°íƒ€ íŒŒì¼ ì—…ë¡œë“œ Â· ì‚­ì œ</legend>
    <div class="row">
      <div>
        <label>ì €ì¥ ê²½ë¡œ (ì˜ˆ: assets/reports/dcar-03.pdf)</label>
        <input id="anyPath" placeholder="assets/reports/dcar-03.pdf">
      </div>
      <div>
        <label>íŒŒì¼ ì„ íƒ</label>
        <input id="anyFile" type="file">
      </div>
    </div>
    <div class="btns">
      <button id="btnAnyUpload">íŒŒì¼ ì—…ë¡œë“œ/ê°±ì‹ </button>
      <button class="warn" id="btnAnyDelete">ì´ ê²½ë¡œì˜ íŒŒì¼ ì‚­ì œ</button>
      <span class="note">í´ë”ëŠ” íŒŒì¼ ì—…ë¡œë“œ ì‹œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</span>
    </div>
  </fieldset>

  <div id="log" class="log" aria-live="polite"></div>
</div>

<script>
/* ===== ê³µí†µ ìœ í‹¸ ===== */
const $ = s => document.querySelector(s);
const nowV = () => String(Date.now()); // ìºì‹œë²„ìŠ¤í„°/ì‹ í˜¸
const log = (...a)=>{$('#log').textContent += a.join(' ') + '\n'; $('#log').scrollTop = $('#log').scrollHeight;}
const cfg = ()=>({owner:localStorage.getItem('ghOwner')||'',repo:localStorage.getItem('ghRepo')||'',branch:localStorage.getItem('ghBranch')||'main',token:localStorage.getItem('ghToken')||''});
function setMsg(text, cls=''){ const el=$('#msg'); el.textContent=text; el.className='note '+cls; }
function signalRefresh(){ localStorage.setItem('lastArtworksUpdate', nowV()); } // âš¡ Works ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨ ì‹ í˜¸

/* ===== ì„¤ì • ë¡œë“œ/ì €ì¥ ===== */
function loadCfg(){ $('#ghOwner').value=localStorage.getItem('ghOwner')||''; $('#ghRepo').value=localStorage.getItem('ghRepo')||''; $('#ghBranch').value=localStorage.getItem('ghBranch')||'main'; $('#ghToken').value=localStorage.getItem('ghToken')||''; }
function saveCfg(){ localStorage.setItem('ghOwner',$('#ghOwner').value.trim()); localStorage.setItem('ghRepo',$('#ghRepo').value.trim()); localStorage.setItem('ghBranch',$('#ghBranch').value.trim()||'main'); localStorage.setItem('ghToken',$('#ghToken').value.trim()); $('#connMsg').textContent='ë¡œì»¬ ì €ì¥ ì™„ë£Œ'; }

/* ===== GitHub API ===== */
async function gh(path, opt={}){
  const {owner,repo,token} = cfg();
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const headers = {'Content-Type':'application/json'};
  if(token) headers.Authorization = `token ${token}`;
  return fetch(url, {method: opt.method||'GET', headers, body: opt.body?JSON.stringify(opt.body):undefined});
}
async function getSHA(path){ const res=await gh(path,{method:'GET'}); if(!res.ok) return null; const j=await res.json(); return j.sha||null; }
function b64Text(str){ return btoa(unescape(encodeURIComponent(str))); }
async function putFile(path, base64, message){
  const sha = await getSHA(path);
  const body = {message, content: base64, branch: cfg().branch};
  if(sha) body.sha = sha;
  const res = await gh(path,{method:'PUT', body});
  if(!res.ok){ throw new Error('PUT ì‹¤íŒ¨: '+await res.text()); }
  return res.json();
}
async function deleteFile(path, message){
  const sha = await getSHA(path);
  if(!sha) throw new Error('ì‚­ì œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: '+path);
  const body = {message, sha, branch: cfg().branch};
  const res = await gh(path,{method:'DELETE', body});
  if(!res.ok){ throw new Error('DELETE ì‹¤íŒ¨: '+await res.text()); }
  return res.json();
}

/* ===== artworks.json I/O ===== */
async function readArtworks(){
  const {owner,repo,branch} = cfg();
  const url = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/artworks.json?v=${nowV()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) return [];
  try { return await res.json(); } catch { return []; }
}
async function writeArtworks(list, msg){
  const text = JSON.stringify(list, null, 2);
  const base64 = b64Text(text);
  await putFile('artworks.json', base64, msg||'update artworks.json');
}

/* ===== í¼ I/O ===== */
function getForm(){ return {series:$('#series').value.trim(), id:$('#artworkId').value.trim(), title:$('#title').value.trim(), year:$('#year').value.trim(), medium:$('#medium').value.trim(), size:$('#size').value.trim()}; }
function setForm(a){ $('#series').value=a.series||'I Light & Memory'; $('#artworkId').value=a.id||''; $('#title').value=a.title||''; $('#year').value=a.year||''; $('#medium').value=a.medium||''; $('#size').value=a.size||''; $('#imageFile').value=''; }
function imagePathFor(id, file){ const ext=(file?.name||'').split('.').pop().toLowerCase(); const safe = (ext==='png')?'png':'jpg'; return `assets/artworks/${id}.${safe}`; }
function nextId(){ const cur=($('#artworkId').value||'').trim(); const m=cur.match(/^(.*?)-(\d+)$/); if(!m) return cur?`${cur}-2`:'Dungzak-1'; return `${m[1]}-${parseInt(m[2],10)+1}`; }
function fileToBase64(file){ return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result.split(',')[1]); fr.onerror=reject; fr.readAsDataURL(file); }); }

/* ===== ë™ì‘: ì €ì¥/ìˆ˜ì •/ì‚­ì œ ===== */
async function saveWithImage(){
  try{
    setMsg('ì—…ë¡œë“œ ì¤‘â€¦');
    const file = $('#imageFile').files[0]; if(!file) return setMsg('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.','err');
    const a = getForm(); if(!a.id) return setMsg('Artwork IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.','err');

    const path = imagePathFor(a.id, file);
    const base64 = await fileToBase64(file);
    await putFile(path, base64, `upload image ${a.id}`);

    const list = await readArtworks();
    const idx = list.findIndex(x=>x.id===a.id);
    const item = {...a, image: path};
    if(idx>=0) list[idx]=item; else list.push(item);
    await writeArtworks(list, `update ${a.id}`);

    signalRefresh(); // âš¡ ì¦‰ì‹œ ë°˜ì˜ ì‹ í˜¸
    setMsg('âœ… ì´ë¯¸ì§€ + ë©”íƒ€ë°ì´í„° ì €ì¥ ì™„ë£Œ','ok');
    await renderList();
  }catch(e){ setMsg('ì˜¤ë¥˜: '+e.message,'err'); log(e.message); }
}

async function saveMetaOnly(){
  try{
    setMsg('ë©”íƒ€ë°ì´í„° ì €ì¥ ì¤‘â€¦');
    const a=getForm(); if(!a.id) return setMsg('Artwork IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.','err');

    const list = await readArtworks();
    const idx = list.findIndex(x=>x.id===a.id);
    const item = idx>=0 ? {...list[idx], ...a} : {...a};
    list[idx>=0?idx:list.length] = item;
    await writeArtworks(list, `update meta ${a.id}`);

    signalRefresh();
    setMsg('âœ… ë©”íƒ€ë°ì´í„° ì €ì¥ ì™„ë£Œ','ok');
    await renderList();
  }catch(e){ setMsg('ì˜¤ë¥˜: '+e.message,'err'); log(e.message); }
}

async function replaceImageOnly(){
  try{
    const file=$('#imageFile').files[0]; if(!file) return setMsg('êµì²´í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.','err');
    const a=getForm(); if(!a.id) return setMsg('Artwork IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.','err');

    const path=imagePathFor(a.id,file);
    const base64=await fileToBase64(file);
    await putFile(path, base64, `replace image ${a.id}`);

    signalRefresh();
    setMsg('âœ… ì´ë¯¸ì§€ êµì²´ ì™„ë£Œ','ok');
  }catch(e){ setMsg('ì˜¤ë¥˜: '+e.message,'err'); log(e.message); }
}

async function deleteArtwork(){
  try{
    const id=$('#artworkId').value.trim(); if(!id) return setMsg('ì‚­ì œí•  Artwork IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.','err');

    const list=await readArtworks();
    const idx=list.findIndex(x=>x.id===id);
    if(idx<0) return setMsg('í•´ë‹¹ IDê°€ ëª©ë¡ì— ì—†ìŠµë‹ˆë‹¤.','err');
    const removed=list.splice(idx,1)[0];
    await writeArtworks(list, `delete ${id}`);

    if(removed.image){ try{ await deleteFile(removed.image, `delete image ${id}`); }catch(e){ log('ì´ë¯¸ì§€ ì‚­ì œ ê±´ë„ˆëœ€:', e.message); } }

    signalRefresh();
    setMsg(`ğŸ—‘ï¸ ${id} ì‚­ì œ ì™„ë£Œ`,'ok');
    setForm({id:''});
    await renderList();
  }catch(e){ setMsg('ì˜¤ë¥˜: '+e.message,'err'); log(e.message); }
}

async function saveThenNext(){
  await saveWithImage();
  $('#artworkId').value = nextId();
  $('#title').value=''; $('#medium').value=''; $('#size').value='';
  $('#imageFile').value='';
  setMsg('ğŸ¨ ë‹¤ìŒ ì‘í’ˆ ì¤€ë¹„ ì™„ë£Œ (ID ìë™ ì¦ê°€)','ok');
}

/* ===== ëª©ë¡/ê²€ìƒ‰/í¸ì§‘ ===== */
async function renderList(){
  const data = await readArtworks();
  const q = ($('#searchBox').value||'').toLowerCase();
  const rows = data
    .filter(a=>!q || JSON.stringify(a).toLowerCase().includes(q))
    .sort((a,b)=> (a.series||'').localeCompare(b.series||'') || (a.id||'').localeCompare(b.id||''));

  let html = `<table><thead><tr><th>Thumb</th><th>ID</th><th>Title</th><th>Series</th><th>Year</th><th>Size</th></tr></thead><tbody>`;
  for(const a of rows){
    const thumb = a.image ? `${a.image}?v=${nowV()}` : '';
    html += `<tr data-id="${a.id}">
      <td>${thumb?`<img class="thumb" src="${thumb}" alt="">`:''}</td>
      <td>${a.id||''}</td>
      <td>${a.title||''}</td>
      <td>${a.series||''}</td>
      <td>${a.year||''}</td>
      <td>${a.size||''}</td>
    </tr>`;
  }
  html += `</tbody></table>`;
  $('#listWrap').innerHTML = html;

  [...document.querySelectorAll('#listWrap tr[data-id]')].forEach(tr=>{
    tr.addEventListener('click', async ()=>{
      const id = tr.getAttribute('data-id');
      const list = await readArtworks();
      const a = list.find(x=>x.id===id);
      if(a) setForm(a);
      window.scrollTo({top:0,behavior:'smooth'});
      setMsg('âœï¸ ì„ íƒí•œ ì‘í’ˆì„ í¼ì— ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    });
  });
}

/* ===== ì¼ë°˜ íŒŒì¼ ì—…/ì‚­ì œ ===== */
async function anyUpload(){
  try{
    const path=$('#anyPath').value.trim(); const file=$('#anyFile').files[0];
    if(!path||!file) return setMsg('ê²½ë¡œì™€ íŒŒì¼ì„ ì…ë ¥í•˜ì„¸ìš”.','err');
    const base64=await fileToBase64(file);
    await putFile(path, base64, `upload ${path}`);
    signalRefresh();
    setMsg(`âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${path}`,'ok');
  }catch(e){ setMsg('ì˜¤ë¥˜: '+e.message,'err'); log(e.message); }
}
async function anyDelete(){
  try{
    const path=$('#anyPath').value.trim(); if(!path) return setMsg('ì‚­ì œí•  ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.','err');
    await deleteFile(path, `delete ${path}`);
    signalRefresh();
    setMsg(`ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ: ${path}`,'ok');
  }catch(e){ setMsg('ì˜¤ë¥˜: '+e.message,'err'); log(e.message); }
}

/* ===== ì—°ê²° í…ŒìŠ¤íŠ¸ ===== */
async function testConn(){
  try{
    const sha = await getSHA('README.md'); // ì¡´ì¬ ì—¬ë¶€ ë¬´ê´€ í…ŒìŠ¤íŠ¸
    $('#connMsg').textContent = 'ì—°ê²° ì„±ê³µ (í† í°/ê¶Œí•œ OK)';
  }catch{ $('#connMsg').textContent = 'ì—°ê²° ì‹¤íŒ¨: í† í°/ê¶Œí•œ/ì˜¤ë„ˆ/ë¦¬í¬ í™•ì¸'; }
}

/* ===== ë°”ì¸ë”© ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  loadCfg();
  $('#saveCfg').addEventListener('click', saveCfg);
  $('#testConn').addEventListener('click', testConn);

  $('#btnSave').addEventListener('click', saveWithImage);
  $('#btnSaveMeta').addEventListener('click', saveMetaOnly);
  $('#btnReplaceImg').addEventListener('click', replaceImageOnly);
  $('#btnDelete').addEventListener('click', deleteArtwork);
  $('#btnNext').addEventListener('click', saveThenNext);

  $('#btnReload').addEventListener('click', renderList);
  $('#searchBox').addEventListener('input', renderList);

  $('#btnAnyUpload').addEventListener('click', anyUpload);
  $('#btnAnyDelete').addEventListener('click', anyDelete);

  renderList();
});
</script>
</body>
</html>
