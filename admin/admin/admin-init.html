<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DUNGZAK · Admin Init — GitHub 연결 자동 설정</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
:root{--bg:#0b0f1a;--card:#0f1524;--line:#20304a;--ink:#e8eefc;--sub:#9fb4d9;--ok:#8aff9c;--err:#ff9aa2;--accent:#b6ff6e}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45}
.wrap{max-width:860px;margin:28px auto;padding:0 16px}
h1{margin:0 0 8px;font-size:22px}
.pill{display:inline-block;margin-left:8px;padding:3px 10px;border-radius:999px;background:#13213a;color:#b9cef2;font-size:12px}
fieldset{border:1px solid var(--line);border-radius:14px;background:var(--card);padding:16px;margin:14px 0}
legend{color:#b9cef2;padding:0 6px}
label{display:block;font-weight:700;margin:10px 0 6px}
input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0e1422;color:var(--ink)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
button{border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;background:var(--accent);color:#0b0f1a}
button.secondary{background:#1f2b44;color:var(--ink);border:1px solid var(--line)}
.note{font-size:12px;color:var(--sub)}
.msg{margin-top:10px;font-size:13px}
.ok{color:var(--ok)} .err{color:var(--err)}
kbd{background:#0e1422;border:1px solid #1b2945;border-radius:6px;padding:2px 6px}
@media (max-width:680px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>등작 燈酌 — Admin 초기 설정 <span class="pill">Lightflow Ω.3</span></h1>

  <fieldset>
    <legend>GitHub 연결값</legend>
    <div class="row">
      <div>
        <label>GitHub Owner</label>
        <input id="owner" placeholder="예: dungzaknuance-rgb" />
      </div>
      <div>
        <label>Repository</label>
        <input id="repo" placeholder="예: dungzakcestlavie.github.io" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Branch</label>
        <input id="branch" value="main" />
      </div>
      <div>
        <label>Personal Access Token</label>
        <input id="token" type="password" placeholder="github_pat_로 시작하는 토큰" />
      </div>
    </div>
    <div class="btns">
      <button id="saveTest">저장 & 연결 테스트</button>
      <button class="secondary" id="openAdmin" disabled>관리자 열기 (admin-plus)</button>
      <button class="secondary" id="clear">연결값 모두 지우기</button>
    </div>
    <div id="msg" class="msg"></div>
    <p class="note">
      • URL로 자동 세팅 가능: <kbd>?owner=...&repo=...&branch=...&token=...</kbd><br />
      • 권한: <b>Fine-grained token</b>에서 <b>Repository: dungzakcestlavie.github.io</b>, <b>Contents = Read/Write</b>, <b>Metadata = Read</b>.
    </p>
  </fieldset>

  <fieldset>
    <legend>빠른 도움</legend>
    <p>1) 토큰 발급 경로: <kbd>GitHub → Settings → Developer settings → Personal access tokens → Fine-grained</kbd><br />
       2) 생성 후 한 번만 보이는 <kbd>github_pat_...</kbd> 전체를 복사해서 위 토큰 칸에 붙여넣으세요.</p>
  </fieldset>
</div>

<script>
const $ = s => document.querySelector(s);
const msg = (t, cls='') => { const el=$('#msg'); el.textContent=t; el.className='msg '+cls; };

function loadDefaultsFromURL(){
  const u = new URL(location.href);
  const owner = u.searchParams.get('owner');
  const repo = u.searchParams.get('repo');
  const branch = u.searchParams.get('branch');
  const token = u.searchParams.get('token');

  if(owner) $('#owner').value = owner;
  if(repo) $('#repo').value = repo;
  if(branch) $('#branch').value = branch;
  if(token) $('#token').value = token;
}

function loadFromLocal(){
  $('#owner').value = localStorage.getItem('ghOwner') || $('#owner').value || 'dungzaknuance-rgb';
  $('#repo').value  = localStorage.getItem('ghRepo')  || $('#repo').value  || 'dungzakcestlavie.github.io';
  $('#branch').value= localStorage.getItem('ghBranch')|| $('#branch').value|| 'main';
  $('#token').value = localStorage.getItem('ghToken') || $('#token').value || '';
}

function saveToLocal(){
  localStorage.setItem('ghOwner',  $('#owner').value.trim());
  localStorage.setItem('ghRepo',   $('#repo').value.trim());
  localStorage.setItem('ghBranch', $('#branch').value.trim() || 'main');
  localStorage.setItem('ghToken',  $('#token').value.trim());
}

async function testConnection(){
  try{
    const owner  = $('#owner').value.trim();
    const repo   = $('#repo').value.trim();
    const branch = $('#branch').value.trim() || 'main';
    const token  = $('#token').value.trim();

    if(!owner || !repo || !token) { msg('값을 모두 입력하세요.', 'err'); return false; }

    // raw → HEAD 체크로 간이 테스트 (artworks.json 존재 유무와 무관)
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/README.md`;
    const res = await fetch(url, {headers:{'Authorization':'token '+token}});
    if(!res.ok && res.status !== 404){
      msg('연결 실패: 오너/리포/토큰을 확인하세요.', 'err');
      return false;
    }
    msg('연결 성공: 토큰/권한 확인 완료!', 'ok');
    return true;
  }catch(e){
    msg('연결 실패: '+e.message, 'err');
    return false;
  }
}

$('#saveTest').addEventListener('click', async ()=>{
  saveToLocal();
  const ok = await testConnection();
  $('#openAdmin').disabled = !ok;
  if(ok) {
    // 다른 탭에 즉시 알림 (작품 페이지가 열려 있으면 바로 갱신)
    localStorage.setItem('lastArtworksUpdate', String(Date.now()));
  }
});

$('#openAdmin').addEventListener('click', ()=>{
  // 기본 관리자 페이지로 이동
  location.href = '/admin/admin-plus.html?v=' + Date.now();
});

$('#clear').addEventListener('click', ()=>{
  localStorage.removeItem('ghOwner');
  localStorage.removeItem('ghRepo');
  localStorage.removeItem('ghBranch');
  localStorage.removeItem('ghToken');
  $('#openAdmin').disabled = true;
  msg('연결값을 모두 삭제했습니다.', 'ok');
});

// 부팅
document.addEventListener('DOMContentLoaded', ()=>{
  loadDefaultsFromURL();
  loadFromLocal();
});
</script>
</body>
</html>
