<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DUNGZAK CESTLAVIE â€” Report & Portfolio Manager</title>

<!-- UI -->
<style>
  :root { --bg:#0b0c0f; --panel:#111319; --fg:#e9edf1; --muted:#99a3ad; --acc:#ffd86b; --hi:#00c9a7; --line:#262b36; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.65 Pretendard,ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial}
  header{padding:28px 20px;text-align:center;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0f1220,transparent)}
  h1{margin:0 0 6px;font-weight:700;font-size:22px;color:var(--acc)}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .grid{display:grid;gap:16px}
  @media (min-width:960px){ .grid{grid-template-columns:1fr 1fr} }

  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px 16px}
  .card h3{margin:0 0 12px;font-size:16px}
  label{display:block;margin:8px 0 4px;color:var(--muted)}
  input,textarea,select{
    width:100%;background:#0f1117;color:var(--fg);border:1px solid #1b2130;border-radius:10px;padding:10px 12px;font:inherit
  }
  textarea{min-height:110px;resize:vertical}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.acc{background:var(--acc);color:#161616}
  .btn.ok{background:var(--hi);color:white}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--fg)}
  .muted{color:var(--muted)}
  .list-item{padding:10px 0;border-top:1px dashed var(--line)}
  .kvs{display:flex;gap:8px;flex-wrap:wrap}
  .kv{background:#0f1117;border:1px solid var(--line);border-radius:8px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .series{margin-top:8px}
  .series h4{margin:14px 0 8px;font-size:14px;color:#c9d4e5}
  .art-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:720px){ .art-grid{grid-template-columns:repeat(3,1fr)} }
  .art{border:1px solid var(--line);border-radius:10px;padding:8px;background:#0f1117}
  .art img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:6px;background:#0b0c0f}
  .art label{display:flex;gap:8px;align-items:center;margin-top:6px}
  .cap{font-size:12px;color:#b6c0cc}
  .note{margin-top:8px;color:#b6c0cc;font-size:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#172033;border:1px solid #22314a;color:#9fb5d1;font-size:12px}
</style>

<!-- jsPDF for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-NaWTH0Zg4c9uC9r6sGqJqT+1xG4kGq8k+vn7Z4m0O0zQ8t7u2j8VtQxwGqQ5Kq4b4n8s7+vU6mQx9sH2pZQFmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<header>
  <h1>ë“±ì‘ ç‡ˆé…Œ â€” Report & Portfolio Manager</h1>
  <div class="muted">ë³´ê³ ì„œ ì‘ì„± Â· ì‘í’ˆ ì„ íƒ Â· ê³ í’ˆì§ˆ PDF ìë™ ìƒì„±</div>
</header>

<div class="wrap grid">

  <!-- Report editor -->
  <section class="card">
    <h3>â• ìƒˆ ë¯¸í•™ ë³´ê³ ì„œ</h3>
    <label>Report ID</label>
    <input id="r_id" placeholder="ì˜ˆ: dcar01" />
    <label>Title (EN)</label>
    <input id="r_en" placeholder="On Light, Memory, and Being" />
    <label>Title (KO)</label>
    <input id="r_ko" placeholder="ë¹›, ê¸°ì–µ, ì¡´ì¬ì— ê´€í•˜ì—¬" />
    <label>Year</label>
    <input id="r_year" type="number" value="2025" />
    <label>Abstract</label>
    <textarea id="r_abs" placeholder="ìš”ì•½ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
    <div class="row">
      <button class="btn acc" onclick="addReport()">Save in page</button>
      <span class="muted">â€» JSONì— ë³‘í•©ì€ ì €ì¥ í›„ â€˜ë°ì´í„° ë‹¤ìš´ë¡œë“œâ€™ ë²„íŠ¼ìœ¼ë¡œ ì¶”ì¶œ â†’ GitHubì— ì—…ë¡œë“œ</span>
    </div>
  </section>

  <!-- Report list -->
  <section class="card">
    <h3>ğŸ“š ë³´ê³ ì„œ ëª©ë¡</h3>
    <div id="reportList"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn ghost" onclick="downloadReportsJSON()">reports.json ë‚´ë³´ë‚´ê¸°</button>
    </div>
  </section>

  <!-- Artwork picker -->
  <section class="card" style="grid-column:1/-1">
    <h3>ğŸ–¼ï¸ ì‘í’ˆ ì„ íƒ (ì„¹ì…˜ë‹¹ ìµœëŒ€ 20ì )</h3>
    <div class="note">* <span class="pill">ê·œì¹™</span> ê° ì‹œë¦¬ì¦ˆ(ì„¹ì…˜)ë³„ ìµœëŒ€ 20ì ë§Œ í¬íŠ¸í´ë¦¬ì˜¤ì— í¬í•¨ë©ë‹ˆë‹¤. ì´ˆê³¼ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ì˜ë¦½ë‹ˆë‹¤.</div>
    <div id="artContainer"></div>
  </section>

  <!-- Portfolio build -->
  <section class="card" style="grid-column:1/-1">
    <h3>ğŸ“„ í¬íŠ¸í´ë¦¬ì˜¤ PDF ìƒì„±</h3>
    <div class="row">
      <select id="reportForPDF"></select>
      <button class="btn ok" onclick="buildPortfolioPDF()">í¬íŠ¸í´ë¦¬ì˜¤ PDF ë§Œë“¤ê¸°</button>
      <span class="muted">ì„ íƒí•œ ë³´ê³ ì„œ + ì„ íƒ ì‘í’ˆ(ì„¹ì…˜ ìµœëŒ€ 20)ìœ¼ë¡œ í•©ì³ì„œ í•œ ë²ˆì— PDF ìƒì„±</span>
    </div>
  </section>
</div>

<script>
/** ---------- ìƒíƒœ ---------- **/
let reports = [];          // data/reports.json ë¡œë“œ + í™”ë©´ì—ì„œ ì¶”ê°€
let artworksBySeries = {}; // data/artworks.json ë¡œë“œ í›„ ì‹œë¦¬ì¦ˆë³„ ê·¸ë£¹
const ART_LIMIT_PER_SERIES = 20;

/** ---------- ë°ì´í„° ë¡œë“œ ---------- **/
(async function init(){
  await loadReports();
  await loadArtworks();
  renderReportList();
  renderReportSelect();
  renderArtworks();
})();

async function loadReports(){
  try{
    const res = await fetch('../data/reports.json?__='+Date.now());
    const json = await res.json();
    reports = json.reports || [];
  }catch(e){
    reports = [];
  }
}
async function loadArtworks(){
  // ê¸°ëŒ€ êµ¬ì¡°: data/artworks.json { "items":[ {id,title,series,year,image:"/images/artworks/xxx.jpg", ...}, ... ] }
  try{
    const res = await fetch('../data/artworks.json?__='+Date.now());
    const data = await res.json();
    const items = data.items || [];
    artworksBySeries = groupBy(items, x => x.series || 'Uncategorized');
  }catch(e){
    artworksBySeries = {};
  }
}

/** ---------- ìœ í‹¸ ---------- **/
function groupBy(arr, keyFn){
  return arr.reduce((m, it)=>{
    const k = keyFn(it);
    (m[k]||(m[k]=[])).push(it);
    return m;
  }, {});
}
function el(tag, attrs={}, ...children){
  const n = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==='class') n.className=v;
    else if(k==='html') n.innerHTML=v;
    else n.setAttribute(k,v);
  }
  for(const c of children) n.append(c);
  return n;
}
function toDataURL(url){ // ì´ë¯¸ì§€ URL â†’ dataURL
  return fetch(url).then(r=>r.blob())
    .then(b=>new Promise(res=>{
      const fr = new FileReader();
      fr.onload=()=>res(fr.result);
      fr.readAsDataURL(b);
    }));
}

/** ---------- ë³´ê³ ì„œ ---------- **/
function addReport(){
  const r = {
    id: r_id.value.trim(),
    title_en: r_en.value.trim(),
    title_ko: r_ko.value.trim(),
    year: r_year.value.trim(),
    abstract: r_abs.value.trim()
  };
  if(!r.id || !r.title_en){ alert('IDì™€ ì˜ë¬¸ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
  const exist = reports.find(x=>x.id===r.id);
  if(exist){ Object.assign(exist, r); }
  else reports.push(r);
  renderReportList(); renderReportSelect();
  alert('âœ… ë³´ê³ ì„œê°€ í™”ë©´ ìƒíƒœì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ë°ì´í„° íŒŒì¼ ë°˜ì˜ì€ "reports.json ë‚´ë³´ë‚´ê¸°" ì‚¬ìš©)');
}
function renderReportList(){
  const box = document.getElementById('reportList');
  box.innerHTML='';
  if(!reports.length){ box.innerHTML='<div class="muted">ë“±ë¡ëœ ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  reports.forEach(r=>{
    box.appendChild(el('div',{class:'list-item'}, 
      el('div',{class:'kvs'},
        el('span',{class:'kv'},`ID: ${r.id}`),
        el('span',{class:'kv'},`Year: ${r.year||'-'}`)
      ),
      el('div',{style:'margin-top:6px'}, `${r.title_en} / ${r.title_ko||''}`),
      el('div',{class:'muted',style:'margin-top:4px'}, (r.abstract||'').slice(0,140) + (r.abstract?.length>140?'â€¦':'')),
      el('div',{class:'row',style:'margin-top:8px'},
        (()=>{ const b=el('button',{class:'btn ghost'},'ğŸ“„ ê°œë³„ PDF'); b.onclick=()=>downloadReportPDF(r.id); return b;})()
      )
    ));
  });
}
function renderReportSelect(){
  const sel = document.getElementById('reportForPDF');
  sel.innerHTML='';
  if(!reports.length){ sel.appendChild(el('option',{value:''},'ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤')); return; }
  for(const r of reports){
    sel.appendChild(el('option',{value:r.id}, `${r.id} â€” ${r.title_en}`));
  }
}
function downloadReportsJSON(){
  const blob = new Blob([JSON.stringify({reports},null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'reports.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

/** ---------- ì‘í’ˆ ---------- **/
function renderArtworks(){
  const root = document.getElementById('artContainer');
  root.innerHTML='';

  const seriesNames = Object.keys(artworksBySeries);
  if(!seriesNames.length){
    root.innerHTML = '<div class="muted">ì‘í’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (data/artworks.json)</div>';
    return;
  }

  seriesNames.forEach(name=>{
    const group = artworksBySeries[name] || [];
    const wrap = el('div',{class:'series'});
    wrap.appendChild(el('h4',{}, `${name} (ì´ ${group.length}ì  Â· ìµœëŒ€ 20 ì„ íƒ)`));

    const grid = el('div',{class:'art-grid'});
    group.forEach((a,idx)=>{
      const id = `art_${name}_${idx}`;
      grid.appendChild(
        el('div',{class:'art'},
          el('img',{src: a.image || `/images/artworks/${a.id||idx}.jpg` , alt:a.title||a.id||'art'}),
          el('label',{},
            el('input',{type:'checkbox', 'data-series':name, 'data-id':a.id||`${name}-${idx}`, 'data-title':a.title||'', 'data-year':a.year||'', 'data-image': (a.image||'') }),
            el('span',{class:'cap'}, `${a.title||'Untitled'} Â· ${a.year||''}`)
          )
        )
      );
    });
    wrap.appendChild(grid);
    wrap.appendChild(el('div',{class:'note'}, `ì„ íƒ ìˆ˜ ì´ˆê³¼ ì‹œ ìë™ìœ¼ë¡œ ì• 20ì ê¹Œì§€ í¬í•¨ë©ë‹ˆë‹¤.`));
    root.appendChild(wrap);
  });
}

function getSelectedArtworksBySeries(){
  const checked = [...document.querySelectorAll('#artContainer input[type=checkbox]:checked')];
  const grouped = {};
  for(const c of checked){
    const s = c.dataset.series;
    (grouped[s]||(grouped[s]=[])).push({
      id:c.dataset.id, title:c.dataset.title, year:c.dataset.year, image:c.dataset.image
    });
  }
  // ì‹œë¦¬ì¦ˆë³„ ìµœëŒ€ 20ì  ì œí•œ
  for(const s of Object.keys(grouped)){
    grouped[s] = grouped[s].slice(0, ART_LIMIT_PER_SERIES);
  }
  return grouped;
}

/** ---------- ê°œë³„ ë³´ê³ ì„œ PDF ---------- **/
async function downloadReportPDF(reportId){
  const r = reports.find(x=>x.id===reportId);
  if(!r) return alert('ë³´ê³ ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});

  let y=80;
  doc.setFontSize(18); doc.text('DUNGZAK CESTLAVIE â€” Aesthetic Report', 40, y); y+=24;
  doc.setFontSize(14); doc.text(`ID: ${r.id}`, 40, y); y+=18;
  doc.text(`Title (EN): ${r.title_en}`, 40, y); y+=18;
  if(r.title_ko){ doc.text(`Title (KO): ${r.title_ko}`, 40, y); y+=18; }
  if(r.year){ doc.text(`Year: ${r.year}`, 40, y); y+=24; }
  doc.setFontSize(12);
  doc.text('Abstract:', 40, y); y+=18;

  const lines = doc.splitTextToSize(r.abstract||'', 520);
  lines.forEach(line=>{
    if(y>780){ doc.addPage(); y=60; }
    doc.text(line, 40, y); y+=16;
  });

  doc.save(`${r.id}.pdf`);
}

/** ---------- í¬íŠ¸í´ë¦¬ì˜¤ PDF (ë³´ê³ ì„œ + ì‘í’ˆ) ---------- **/
async function buildPortfolioPDF(){
  const reportId = (document.getElementById('reportForPDF').value||'').trim();
  if(!reportId) return alert('ë¨¼ì € ë³´ê³ ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  const r = reports.find(x=>x.id===reportId);
  if(!r) return alert('ë³´ê³ ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  const selected = getSelectedArtworksBySeries();
  const seriesNames = Object.keys(selected);
  if(!seriesNames.length) return alert('í¬í•¨í•  ì‘í’ˆì„ ì„ íƒí•˜ì„¸ìš”.');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  let y = 100;

  // í‘œì§€
  doc.setFillColor(18,22,33);
  doc.rect(0,0,595,842,'F');
  doc.setTextColor(255,216,107);
  doc.setFontSize(22);
  doc.text('DUNGZAK CESTLAVIE â€” Portfolio', 50, y); y+=30;
  doc.setTextColor(233,237,241);
  doc.setFontSize(14);
  doc.text(`Report â€” ${r.id}`, 50, y); y+=18;
  doc.text(r.title_en, 50, y); y+=18;
  if(r.title_ko){ doc.text(r.title_ko, 50, y); y+=18; }
  if(r.year){ doc.text(`Year: ${r.year}`, 50, y); }
  doc.addPage();

  // Abstract í˜ì´ì§€
  y=70;
  doc.setFontSize(16); doc.text('Abstract', 50, y); y+=22;
  doc.setFontSize(12);
  doc.setTextColor(200,210,220);
  const absLines = doc.splitTextToSize(r.abstract||'', 500);
  for(const line of absLines){
    if(y>780){ doc.addPage(); y=60; }
    doc.text(line, 50, y); y+=16;
  }
  doc.addPage();

  // ì‹œë¦¬ì¦ˆë³„ ì•„íŠ¸ì›Œí¬ ì¸ë„¤ì¼ + ìº¡ì…˜
  doc.setTextColor(233,237,241);
  for(const s of seriesNames){
    y=70;
    doc.setFontSize(15); doc.text(`Series â€” ${s} (max ${ART_LIMIT_PER_SERIES})`, 50, y); y+=18;
    const items = selected[s]||[];

    // ì¸ë„¤ì¼ 3ì—´ ë ˆì´ì•„ì›ƒ
    let x=50; let col=0;
    for(const a of items){
      if(y>740){ doc.addPage(); y=70; x=50; col=0; doc.setFontSize(15); doc.text(`Series â€” ${s} (cont.)`, 50, y); y+=18; }
      const imgUrl = a.image || `/images/artworks/${a.id}.jpg`;
      try{
        const dataURL = await toDataURL(imgUrl);
        // ì¸ë„¤ì¼ ì‚¬ì´ì¦ˆ (í­ 150, ë¹„ìœ¨ì— ë§ì¶° ë†’ì´ 150ë¡œ)
        doc.addImage(dataURL, 'JPEG', x, y, 150, 150, undefined, 'FAST');
      }catch(e){
        // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ í”Œë ˆì´ìŠ¤í™€ë”
        doc.setDrawColor(80); doc.rect(x,y,150,150);
        doc.setFontSize(10); doc.text('Image not found', x+24,y+78);
      }
      // ìº¡ì…˜
      doc.setFontSize(11); doc.setTextColor(200,210,220);
      const cap = `${a.title||'Untitled'} ${a.year?`Â· ${a.year}`:''}`;
      const capLines = doc.splitTextToSize(cap, 150);
      let cy = y+150+14;
      for(const line of capLines){
        if(cy>800){ doc.addPage(); cy=70; }
        doc.text(line, x, cy); cy+=12;
      }

      // ë‹¤ìŒ ì¹¸
      col++; x += 170;
      if(col===3){ col=0; x=50; y+=200; }
    }
    doc.addPage();
  }

  // ë§ˆì§€ë§‰ í˜ì´ì§€ â€” í¬ë ˆë”§
  doc.setFillColor(10,12,15); doc.rect(0,0,595,842,'F');
  doc.setTextColor(255,216,107); doc.setFontSize(18);
  doc.text('DUNGZAK CESTLAVIE', 50, 120);
  doc.setTextColor(200,210,220); doc.setFontSize(12);
  doc.text('This portfolio was generated automatically by Report & Portfolio Manager.', 50, 150);

  const fname = `${r.id}_portfolio.pdf`;
  doc.save(fname);
}

/** ì´ë¯¸ì§€ to dataURL ìœ í‹¸ (ë™ì¼ ì¶œì²˜ ê²½ë¡œ ê¶Œì¥) **/
function toDataURL(url){
  return fetch(url, {cache:'no-store'}).then(r=>r.blob())
    .then(b=>new Promise(res=>{
      const fr = new FileReader();
      fr.onload=()=>res(fr.result);
      fr.readAsDataURL(b);
    }));
}
</script>
</body>
</html>
